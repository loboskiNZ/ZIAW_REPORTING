<%- include('header') %>

<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
  <h1>Workspace: <%= workspace.name %> <small style="font-weight: normal; color: #777;">(#<%= workspace.id %>)</small></h1>
  <div>
    <a href="/ui/workspaces" class="btn btn-secondary btn-sm">&larr; Back</a>
  </div>
</div>

<div style="display: grid; grid-template-columns: 2fr 1fr; gap: 24px;">

  <!-- Main Column -->
  <div>
    <!-- Snapshot Info -->
    <div class="card">
      <h3>Latest Snapshot</h3>
      <% if (snapshot) { %>
        <table style="margin: 0;">
          <tr>
            <td><strong>Timestamp:</strong> <%= new Date(snapshot.snapshot_at).toLocaleString() %></td>
            <td><strong>Valid:</strong> 
              <% if (snapshot.is_valid) { %> <span class="badge badge-PASS">YES</span> <% } else { %> <span class="badge badge-FAIL">NO</span> <% } %>
            </td>
          </tr>
          <tr>
            <td colspan="2">
              <strong>Scores:</strong> 
              Progress: <%= snapshot.progress_score %> | 
              Risk: <%= snapshot.risk_score %> | 
              Readiness: <%= snapshot.readiness_score %> | 
              Confidence: <%= snapshot.confidence_score %>
            </td>
          </tr>
        </table>
      <% } else { %>
        <p>No snapshot found.</p>
      <% } %>
    </div>

    <!-- Actions -->
    <div class="card">
      <h3>Actions</h3>
      <div class="actions">
        <!-- Submit Form -->
        <form action="/ui/workspaces/<%= workspace.id %>/submit" method="POST" style="display: inline;">
          <input type="hidden" name="rationale" value="UI Submission">
          <button type="submit" class="btn btn-success" 
            <%= workspace.cab_readiness_status === 'PENDING_REVIEW' || workspace.cab_review_state === 'IN_REVIEW' ? 'disabled' : '' %>>
            Submit for CAB
          </button>
        </form>

        <!-- Approve Form -->
        <form action="/ui/workspaces/<%= workspace.id %>/approve" method="POST" style="display: inline;">
          <button type="submit" class="btn btn-success"
            <%= workspace.cab_review_state !== 'IN_REVIEW' ? 'disabled' : '' %>>
            Vote Approve
          </button>
        </form>

        <!-- Reject Form -->
        <form action="/ui/workspaces/<%= workspace.id %>/reject" method="POST" style="display: inline;">
          <button type="submit" class="btn btn-danger"
            <%= workspace.cab_review_state !== 'IN_REVIEW' ? 'disabled' : '' %>>
            Reject
          </button>
        </form>
      </div>
    </div>

    <!-- Audit History -->
    <div class="card">
      <h3>Audit History</h3>
      <table>
        <thead>
          <tr>
            <th>Time</th>
            <th>Action</th>
            <th>Actor</th>
            <th>Rationale</th>
            <th>Evidence</th>
          </tr>
        </thead>
        <tbody>
          <% audit.forEach(function(a) { %>
            <tr>
              <td><%= new Date(a.created_at).toLocaleString() %></td>
              <td><%= a.action %></td>
              <td title="Type: <%= a.actor_type %>"><%= a.actor %></td>
              <td><%= a.rationale %></td>
              <td>
                <a href="/ui/workspaces/<%= workspace.id %>/evidence?audit_id=<%= a.id %>">
                  See Evidence (<%= a.evidence_count %>)
                </a>
              </td>
            </tr>
          <% }); %>
          <% if (audit.length === 0) { %>
            <tr><td colspan="5">No history.</td></tr>
          <% } %>
        </tbody>
      </table>
    </div>
  </div>

  <!-- Side Column -->
  <div>
    <!-- Status Card -->
    <div class="card">
      <h3>Status</h3>
      <div class="form-group">
        <label>Stage</label>
        <div><%= workspace.pipeline_stage %></div>
      </div>
      <div class="form-group">
        <label>Readiness</label>
        <div class="badge badge-<%= workspace.cab_readiness_status %>"><%= workspace.cab_readiness_status %></div>
      </div>
      <div class="form-group">
        <label>Review State</label>
        <div class="badge badge-<%= workspace.cab_review_state %>"><%= workspace.cab_review_state %></div>
      </div>
      <div class="form-group">
        <label>Approvals</label>
        <div><%= workspace.cab_approval_count %> / <%= workspace.cab_required_approvals %></div>
      </div>
      <div class="form-group">
        <label>Submitted</label>
        <div><%= workspace.cab_submitted_at ? new Date(workspace.cab_submitted_at).toLocaleString() : '-' %></div>
      </div>
      <div class="form-group">
        <label>Expires</label>
        <div><%= workspace.cab_expires_at ? new Date(workspace.cab_expires_at).toLocaleString() : '-' %></div>
      </div>
    </div>

    <!-- Checklist Card -->
    <div class="card">
      <h3>Checklists (VERIFY_CAB)</h3>
      <div style="display: flex; gap: 10px;">
        <div style="text-align: center;">
          <div style="font-size: 20px; font-weight: bold;"><%= checklist.passed %></div>
          <div style="font-size: 12px; color: #666;">Passed</div>
        </div>
        <div style="text-align: center;">
          <div style="font-size: 20px; font-weight: bold;"><%= checklist.failed %></div>
          <div style="font-size: 12px; color: #666;">Remaining</div>
        </div>
        <div style="text-align: center;">
          <div style="font-size: 20px; font-weight: bold;"><%= checklist.required %></div>
          <div style="font-size: 12px; color: #666;">Total</div>
        </div>
      </div>
    </div>

    <!-- Reviewers Card -->
    <div class="card">
      <h3>Reviewers</h3>
      <ul style="padding-left: 20px; margin-top: 0;">
        <% reviewers.forEach(function(r) { %>
          <li>
            <%= r.reviewer_id %> 
            <span style="font-size: 0.8em; color: #666;">(<%= r.role %>)</span>
          </li>
        <% }); %>
      </ul>
      <a href="/ui/workspaces/<%= workspace.id %>/reviewers" class="btn btn-secondary btn-sm" style="width: 100%; text-align: center; box-sizing: border-box;">Manage Reviewers</a>
    </div>
  </div>

</div>

<%- include('footer') %>
